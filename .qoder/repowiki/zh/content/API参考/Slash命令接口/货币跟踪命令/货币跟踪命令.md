# 货币跟踪命令

<cite>
**本文档中引用的文件**  
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua)
- [CurrencyDataManager.lua](file://CurrencyTracker/CurrencyDataManager.lua)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua)
- [CurrencyConstants.lua](file://CurrencyTracker/CurrencyConstants.lua)
</cite>

## 目录
1. [简介](#简介)
2. [核心命令解析](#核心命令解析)
3. [/ct show 命令参数解析](#ct-show-命令参数解析)
4. [/ct show-all-currencies 命令实现](#ct-show-all-currencies-命令实现)
5. [/ct meta show 命令功能](#ct-meta-show-命令功能)
6. [/ct debug 命令调试模式](#ct-debug-命令调试模式)
7. [/ct status 命令状态查询](#ct-status-命令状态查询)
8. [/ct discover 命令子命令管理](#ct-discover-命令子命令管理)
9. [/ct repair 命令数据修复机制](#ct-repair-命令数据修复机制)
10. [命令分发器实现](#命令分发器实现)

## 简介
货币跟踪命令系统是Accountant_Classic插件的核心功能之一，提供了一套完整的命令行接口来管理和查询游戏内货币数据。该系统通过/CurrencyCore.lua中的CommandDispatcher实现，支持多种命令和子命令，允许用户查看、调试和修复货币跟踪数据。本文档深入解析/ct命令族的完整功能集，详细说明各个命令的实现逻辑和使用方法。

## 核心命令解析
货币跟踪命令系统通过/CurrencyCore.lua中的CommandDispatcher实现，注册了/ct作为主命令。该系统支持多种命令和子命令，包括显示货币数据、调试模式切换、状态查询、发现管理、数据修复等。命令解析逻辑在SlashCmdList["CURRENCYTRACKER"]函数中实现，通过字符串匹配来分发不同的命令。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L1032-L1413)

## /ct show 命令参数解析
/ct show命令用于显示指定货币的数据，支持多种时间范围参数。命令的参数解析逻辑在CurrencyTracker:ShowCurrencyData函数中实现。

### 货币ID验证
当未提供货币ID时，系统会尝试从DataManager中加载上次选择的货币ID。如果仍然无法确定，则显示错误信息并返回。

### 默认值设定
如果未提供货币ID，系统会使用DataManager:LoadCurrencySelection()加载默认货币ID。这个默认值通常存储在SavedVariables中，允许用户自定义默认查看的货币。

### 未提供参数时的行为
当未提供任何参数时，系统会显示使用帮助信息，提示用户正确的命令格式："No currency selected. Usage: /ct show <timeframe> [currencyid]"。

### 白名单过滤
系统支持白名单过滤功能，通过CurrencyConstants.CurrencyWhitelist定义允许显示的货币ID列表。当白名单过滤开启时（默认开启），只有在白名单中的货币才会被显示。

### 跟踪状态过滤
系统还会检查货币的跟踪状态，通过GetDiscoveredCurrencies获取发现的货币元数据，只有标记为tracked=true的货币才会被显示。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L1032-L1150)

## /ct show-all-currencies 命令实现
/ct show-all-currencies命令用于遍历Accountant_Classic_CurrencyDB中的所有已知货币并格式化输出。该功能通过CurrencyTracker:PrintMultipleCurrencies函数实现。

### 遍历所有货币
系统首先通过GetAvailableCurrencies获取所有可用的货币ID列表。这个列表可能来自Storage或DataManager，具体取决于模块的初始化状态。

### 数据收集
系统使用CollectMultipleCurrencies函数收集每个货币的数据，包括货币ID、名称、收入、支出、净变化和总量上限等信息。

### 格式化输出
收集到的数据会被格式化为易于阅读的文本输出，每行显示一个货币的信息，包括：
- 货币名称和ID
- 收入数量
- 支出数量
- 净变化（带正负号）
- 总量上限（如果存在）

### 详细模式
命令支持verbose参数，当指定时会显示未跟踪的货币，允许用户查看所有已发现的货币而不仅仅是跟踪的货币。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L1301-L1413)

## /ct meta show 命令功能
/ct meta show命令用于暴露原始元数据用于调试，允许开发者查看货币获取和消耗的详细来源统计。

### 元数据结构
元数据存储在Accountant_ClassicSaveData的currencyMeta字段中，按货币ID和时间段组织。每个元数据节点包含：
- gain: 获取来源统计
- lost: 消耗来源统计
- last: 最后一次变更记录

### 来源代码解析
系统使用SourceCodeTokens和DestroyReasonTokens映射表将数字来源代码转换为可读的标签。对于现代客户端（11.0.2+），lost来源会显示为"Destroy/Lost sources"。

### 输出格式
命令输出格式化为：
- 货币时间段和ID标题
- 获取来源列表（按来源代码排序）
- 消耗来源列表（按来源代码排序）
- 最后一次变更的详细信息

### 本地化支持
系统会尝试使用本地化标签替换来源代码，如果存在对应的本地化字符串，则显示本地化名称而非代码。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L190-L252)

## /ct debug 命令调试模式
/ct debug命令用于切换CurrencyCore的调试日志模式，影响控制台输出的详细程度。

### 调试模式状态
调试模式状态由CurrencyTracker.DEBUG_MODE布尔变量控制，默认为false（关闭）。

### 切换逻辑
命令支持两个参数：
- on: 开启调试模式
- off: 关闭调试模式

当不提供参数时，显示当前状态和使用帮助。

### 日志输出
当调试模式开启时，LogDebug函数会输出调试信息；当关闭时，这些信息会被抑制。调试信息包括模块初始化、事件处理等内部状态。

### 运行时切换
调试模式可以在运行时动态切换，无需重新加载界面，这使得调试过程更加高效。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L485-L550)

## /ct status 命令状态查询
/ct status命令用于收集并打印模块内部状态，提供系统健康状况的概览。

### 状态信息收集
系统通过GetStatus函数收集以下状态信息：
- isInitialized: 模块是否已初始化
- isEnabled: 模块是否已启用
- version: 模块版本号
- debugMode: 调试模式状态

### UI控制器状态
如果UI控制器存在，还会收集其系统状态，提供更完整的状态视图。

### 输出格式
状态信息以清晰的格式输出，每行显示一个状态项，便于用户快速了解系统状态。

### 错误处理
状态查询函数设计为尽可能健壮，即使部分子系统不可用也能返回基本状态信息。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L485-L550)

## /ct discover 命令子命令管理
/ct discover命令的子命令用于管理货币发现状态，包括列表查看、跟踪设置和清除操作。

### list子命令
discover list命令列出所有已发现的货币，显示：
- 货币ID
- 货币名称（或默认名称）
- 跟踪状态

结果按货币ID排序，确保输出的一致性。

### track子命令
discover track命令用于设置货币的跟踪状态：
- 支持on/off参数明确设置状态
- 不提供参数时切换当前状态
- 自动尝试填充缺失的元数据

### reset子命令
系统中没有专门的reset子命令，但clear子命令具有类似功能。

### migrate子命令
系统中没有migrate子命令，但Storage模块包含数据迁移功能，如MigrateZeroSourceToBaselinePrime。

### clear子命令
discover clear命令清除所有已发现的货币，用于重置发现状态。操作会返回清除的货币数量。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L190-L252)

## /ct repair 命令数据修复机制
/ct repair命令提供了一套数据修复工具，用于修正货币跟踪数据中的不一致。

### 安全考量
修复操作设计有多个安全机制：
- 参数验证：严格验证输入参数
- 边界检查：防止负数或零值
- 事务性操作：确保数据一致性
- 日志记录：记录所有修复操作

### adjust子命令
repair adjust命令用于调整货币聚合数据：
- 接受货币ID、增量和可选来源
- 正增量增加收入，负增量增加支出
- 影响所有时间段（Session, Day, Week等）

### remove子命令
repair remove命令用于移除已记录的收支：
- 支持收入或支出类型
- 可使用数字或字符串来源
- 从所有时间段中移除指定数量

### baseline子命令
repair baseline命令用于修正基线数据：
- preview模式：预览与实时数据的差异
- apply模式：应用修正使跟踪数据与实时数据一致
- 仅调整Total时间段，不影响其他时间段

### migrate子命令
repair migrate-zero命令用于数据格式迁移：
- 将数字来源0迁移到字符串来源"BaselinePrime"
- 保持数据完整性的同时改善显示
- 提供迁移统计信息

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L485-L550)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L1-L1222)

## 命令分发器实现
命令分发器是整个货币跟踪命令系统的核心，负责解析和分发所有/ct命令。

### 命令注册
系统通过SLASH_CURRENCYTRACKER1 = "/ct"和SlashCmdList["CURRENCYTRACKER"]注册主命令。

### 解析逻辑
命令解析采用字符串匹配方式，优先处理更具体的命令（如show-all-currencies），然后处理通用命令（如show）。

### 错误处理
系统实现了全面的错误处理策略：
- 参数验证：检查必需参数
- 类型转换：安全转换字符串到数字
- 边界检查：验证数值范围
- 异常捕获：使用pcall保护API调用

### 扩展性
命令系统设计具有良好扩展性：
- 模块化命令处理函数
- 统一的错误报告格式
- 可扩展的参数解析
- 支持别名和缩写

### 性能考量
系统优化了性能：
- 惰性加载本地化表
- 缓存常用数据
- 批量操作减少API调用
- 避免重复计算

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L1032-L1413)