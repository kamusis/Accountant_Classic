# 数据库损坏与数据丢失

<cite>
**本文档引用的文件**   
- [Constants.lua](file://Core/Constants.lua)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua)
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua)
- [CurrencyDataManager.lua](file://CurrencyTracker/CurrencyDataManager.lua)
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua)
</cite>

## 目录
1. [简介](#简介)
2. [SavedVariables文件损坏的迹象](#savedvariables文件损坏的迹象)
3. [损坏的成因分析](#损坏的成因分析)
4. [数据恢复机制](#数据恢复机制)
5. [恢复方案与操作指南](#恢复方案与操作指南)
6. [预防措施与最佳实践](#预防措施与最佳实践)

## 简介
本文件详细阐述了Accountant_Classic插件中与货币追踪相关的数据库损坏问题。文档重点分析了SavedVariables文件损坏的典型迹象、根本成因、内置的数据恢复与验证机制，并提供了多种手动和命令行恢复方案。核心内容围绕CurrencyTracker模块的`CurrencyStorage.lua`和`Constants.lua`文件展开，旨在帮助用户理解数据丢失的原理并采取有效措施进行恢复和预防。

## SavedVariables文件损坏的迹象
SavedVariables文件损坏通常表现为用户数据的异常丢失或重置，具体迹象包括：

- **数据重置为默认值**：用户的货币追踪数据，如特定货币的收入、支出记录，被重置为初始状态或`Constants.lua`中定义的默认值。例如，`CurrencyStorage.lua`文件中定义的`DEFAULT_CURRENCY`（默认货币ID 1166，即“时光扭曲徽章”）会在数据丢失后被重新选中。
- **跨角色数据消失**：在同一个账号下，不同服务器或角色的货币追踪数据无法正确加载或显示为空。这通常是因为`Accountant_ClassicSaveData`表中对应服务器和角色的子表（如`[server][character]`）未能正确创建或已损坏。
- **追踪功能失效**：插件的货币追踪功能停止工作，无法记录新的货币变动，或在UI界面中显示“无数据”。
- **配置选项重置**：用户自定义的设置，如选中的货币、追踪启用状态等，恢复到默认值。这在`CurrencyStorage.lua`的`currencyOptions`表中体现，例如`trackingEnabled`字段被重置为`true`，`selectedCurrency`被重置为默认值。

这些迹象表明，存储在`WTF/Account/账户名/SavedVariables/Accountant_Classic.lua`文件中的持久化数据结构遭到了破坏。

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L15-L25)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L436-L489)
- [Constants.lua](file://Core/Constants.lua#L15-L20)

## 损坏的成因分析
SavedVariables文件损坏并非单一原因造成，而是由多种因素共同作用的结果，主要包括：

- **异常退出**：在游戏或插件进行关键的写入操作时，如果发生游戏崩溃、强制关闭或断电，会导致写入过程被中断。这可能产生不完整或格式错误的`.lua`文件，从而在下次启动时无法被正确解析。
- **磁盘写入失败**：底层的文件系统或存储设备（如硬盘、SSD）出现故障，可能导致数据无法成功写入磁盘。即使游戏进程正常结束，数据也可能未能持久化。
- **版本升级兼容性问题**：当插件进行重大版本更新时，其内部的数据结构（如`SavedVariables`的表结构）可能会发生变化。如果新版本的代码尝试读取旧版本的、结构不匹配的数据，或者在迁移过程中出现逻辑错误，就会导致数据解析失败。`CurrencyStorage.lua`中的`MigrateData`函数（未在提供的代码片段中完整显示）正是为了解决此类问题而设计的，但若迁移逻辑本身存在缺陷，也可能成为新的损坏源。
- **内存管理错误**：在极少数情况下，Lua虚拟机的内存管理错误或插件代码中的bug（如对`SavedVariables`表的非法操作）可能导致数据在内存中就被破坏，随后被错误地写入文件。

这些因素共同增加了SavedVariables文件损坏的风险，尤其是在频繁更新或系统不稳定的环境下。

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L436-L489)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L107-L108)

## 数据恢复机制
Accountant_Classic插件内置了多层次的数据恢复与验证机制，以应对潜在的损坏情况。

### 默认数据结构的初始化
当插件检测到`SavedVariables`结构缺失或不完整时，会利用`Constants.lua`中定义的常量来恢复和初始化数据结构。这一过程是恢复机制的核心。

- **常量定义**：`Constants.lua`文件定义了`constants.defaults`表，其中包含了所有配置选项的默认值。例如，`selectedCurrency`的默认值为`1166`，`trackingEnabled`的默认值为`true`。
- **结构重建**：`CurrencyStorage.lua`中的`EnsureSavedVariablesStructure`函数负责检查并重建基本的数据结构。如果`Accountant_ClassicSaveData`全局表不存在，或其下特定服务器、角色的子表缺失，该函数会创建它们，并填充来自`Constants.lua`的默认值。例如，代码会确保`charData.currencyOptions`存在，并设置`selectedCurrency`和`trackingEnabled`等字段。

```mermaid
flowchart TD
A[启动插件] --> B{SavedVariables结构存在?}
B --> |否| C[创建Accountant_ClassicSaveData表]
B --> |是| D{服务器/角色结构存在?}
D --> |否| E[创建[server][character]子表]
D --> |是| F{currencyData存在?}
F --> |否| G[初始化currencyData]
F --> |是| H{currencyOptions存在?}
H --> |否| I[初始化currencyOptions<br>使用Constants.lua中的默认值]
H --> |是| J[数据结构完整，继续初始化]
C --> E
E --> F
G --> H
I --> J
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L436-L489)
- [Constants.lua](file://Core/Constants.lua#L15-L20)

### 数据验证机制
`CurrencyStorage.lua`文件中实现了严格的数据验证流程，以确保数据的完整性和一致性。

- **验证函数**：`ValidateData`函数在插件初始化时被调用，它会遍历`currencyData`和`currencyOptions`等关键数据表。
- **类型检查**：该函数会检查每个字段的类型是否正确。例如，它会验证`currencyOptions.selectedCurrency`是否为数字，`currencyOptions.trackingEnabled`是否为布尔值。
- **自动修复**：如果发现字段类型错误或缺失，`ValidateData`函数会自动将其重置为正确的默认值。例如，如果`selectedCurrency`不是数字，它会被重置为`DEFAULT_CURRENCY`。这确保了即使数据部分损坏，插件也能以一个稳定的状态运行。

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L813-L892)

## 恢复方案与操作指南
当遇到数据丢失问题时，用户可以采取以下几种方案进行恢复。

### 手动备份与替换
这是最直接且可靠的恢复方法，适用于有定期备份习惯的用户。

1.  **定位文件**：找到游戏安装目录下的`WTF/Account/你的账号名/SavedVariables/`文件夹。
2.  **查找文件**：在此文件夹中找到名为`Accountant_Classic.lua`的文件。
3.  **执行替换**：
    -   **恢复**：将之前备份的`Accountant_Classic.lua`文件复制回该目录，覆盖当前损坏的文件。
    -   **备份**：在进行任何重大操作（如游戏大版本更新）前，将当前的`Accountant_Classic.lua`文件复制到安全位置（如U盘或云盘）。

### 使用命令行修复
插件提供了内置的命令行工具来修复特定问题。

- **`/ct repair remove` 命令**：此命令用于修复货币数据库中的错误记录。它可以移除特定货币、特定来源的错误收入或支出记录。其底层调用的是`CurrencyStorage.lua`中的`RepairRemove`函数，该函数会遍历`Session`、`Day`、`Week`、`Month`、`Year`和`Total`等所有时间段，并从指定来源中减去指定的金额，从而“修复”数据。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L423-L424)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L178-L190)

### 通过配置界面重置
对于特定角色的数据问题，可以通过插件的配置界面进行重置。

- **重置会话数据**：`CurrencyStorage.lua`中的`ResetSession`函数可以在用户登录时被调用，用于清空当前会话（`Session`）的所有数据。这相当于开始一个全新的追踪会话，但不会影响`Day`、`Week`等更长时间段的数据。
- **重置特定角色**：在配置界面中，通常会有选项允许用户手动重置某个特定角色的所有追踪数据，这会将该角色的`currencyData`表清空，并在下次需要时重新初始化。

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L396-L410)

## 预防措施与最佳实践
为了最大限度地减少数据丢失的风险，建议遵循以下最佳实践：

- **定期备份**：这是最重要的预防措施。养成定期备份`WTF`文件夹的习惯，尤其是在重大游戏版本更新、插件更新或长时间游戏会话之前。可以将备份文件存储在多个位置以增加安全性。
- **重大更新后检查**：在《魔兽世界》或Accountant_Classic插件进行重大版本更新后，务必登录游戏并检查货币追踪数据是否完整。如果发现数据丢失，应立即从备份中恢复。
- **避免异常退出**：尽量通过正常的游戏退出流程来关闭游戏，避免使用任务管理器强制结束进程。
- **保持插件更新**：及时更新到插件的最新稳定版本，因为新版本通常会修复已知的bug和数据兼容性问题。

通过结合使用这些恢复方案和预防措施，用户可以有效地保护自己的游戏数据，确保货币追踪功能的长期稳定运行。

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L396-L410)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L813-L892)