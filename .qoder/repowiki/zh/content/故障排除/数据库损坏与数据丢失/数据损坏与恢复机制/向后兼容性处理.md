# 向后兼容性处理

<cite>
**本文档中引用的文件**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua)
- [CurrencyDataManager.lua](file://CurrencyTracker/CurrencyDataManager.lua)
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua)
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua)
</cite>

## 目录
1. [简介](#简介)
2. [向后兼容性策略](#向后兼容性策略)
3. [数据降级处理](#数据降级处理)
4. [异常安全的数据加载流程](#异常安全的数据加载流程)
5. [结论](#结论)

## 简介
本文件详细说明了Accountant_Classic插件在数据结构升级过程中如何维持向后兼容性。文档重点介绍了通过保留旧字段、提供转换适配层和条件兼容逻辑来确保插件稳定性不受损坏数据影响的策略。结合CurrencyStorage.lua中的错误处理代码，展示了异常安全的数据加载流程。

## 向后兼容性策略

### 保留旧字段与数据结构
插件通过保留旧的数据结构和字段来确保向后兼容性。在CurrencyStorage.lua中，`EnsureSavedVariablesStructure`函数确保了保存变量结构的存在，即使在结构不完整的情况下也能安全地初始化缺失的部分。

```mermaid
flowchart TD
A[开始] --> B{SavedVariables存在?}
B --> |否| C[记录错误并返回false]
B --> |是| D{服务器和角色可用?}
D --> |否| E[记录错误并返回false]
D --> |是| F{服务器结构存在?}
F --> |否| G[创建服务器结构]
F --> |是| H{角色结构存在?}
H --> |否| I[创建角色结构]
H --> |是| J[返回true]
G --> J
I --> J
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L200-L230)

### 转换适配层
插件提供了多个转换适配层来处理不同版本的数据。`MigrateZeroSourceToBaselinePrime`函数将数字源键0迁移到字符串键"BaselinePrime"，这是一个外观修复，避免显示"ConvertOldItem"。

```mermaid
sequenceDiagram
participant 插件 as CurrencyTracker
participant 存储 as Storage
participant 数据 as SavedVariables
插件->>存储 : Initialize()
存储->>存储 : InitializeCurrencyStorage()
存储->>数据 : 确保结构存在
存储->>存储 : 迁移旧数据(如果需要)
存储->>存储 : 验证数据完整性
存储->>存储 : 执行日志滚动
存储->>存储 : 重置会话数据
存储-->>插件 : 返回成功状态
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L150-L195)

### 条件兼容逻辑
插件实现了条件兼容逻辑来处理不同版本的客户端。在CurrencyEventHandler.lua中，事件注册逻辑根据客户端功能动态调整：

```mermaid
flowchart TD
A[注册事件] --> B{C_CurrencyInfo可用?}
B --> |是| C[注册CURRENCY_DISPLAY_UPDATE]
B --> |否| D[注册BAG_UPDATE]
C --> E[现代客户端事件处理]
D --> F[传统客户端事件处理]
```

**Diagram sources**
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua#L300-L350)

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L150-L230)
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua#L300-L350)

## 数据降级处理

### 默认值策略
当遇到无法解析的数据时，插件使用默认值策略来确保功能正常。在CurrencyStorage.lua中，`DEFAULT_CURRENCY`常量定义了默认货币ID：

```mermaid
classDiagram
class Storage {
+CURRENCY_VERSION : string
+DEFAULT_CURRENCY : number
+TIME_PERIODS : table
+Initialize()
+InitializeCurrencyStorage()
+InitializeCurrencyData(currencyID)
+ValidateData()
}
class Constants {
+SupportedCurrencies : table
+Utils : table
+VersionUtils : table
}
Storage --> Constants : 使用默认值
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L130-L140)

### 跳过异常条目
插件在处理损坏数据时会跳过异常条目，而不是让整个处理流程失败。`ValidateData`函数在CurrencyStorage.lua中实现了这一策略：

```mermaid
flowchart TD
A[开始验证] --> B{currencyData存在?}
B --> |否| C[跳过]
B --> |是| D[遍历所有货币]
D --> E{数据结构有效?}
E --> |否| F[记录错误并清理]
E --> |是| G[验证时间周期]
G --> H{周期数据有效?}
H --> |否| I[重置周期数据]
H --> |是| J[继续]
F --> J
I --> J
J --> K{所有货币处理完毕?}
K --> |否| D
K --> |是| L[完成验证]
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L850-L900)

### 记录警告日志
插件在遇到问题时会记录详细的警告日志，而不是静默失败。`SafeLogError`和`SafeLogDebug`函数确保了日志记录的安全性：

```mermaid
sequenceDiagram
participant 函数 as Function
participant 日志 as SafeLogError
participant 输出 as DEFAULT_CHAT_FRAME
函数->>日志 : 调用日志函数
日志->>日志 : 检查CurrencyTracker可用性
日志->>日志 : 格式化消息
日志->>输出 : 发送到聊天框
输出-->>日志 : 确认
日志-->>函数 : 返回
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L10-L40)

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L850-L900)

## 异常安全的数据加载流程

### 安全初始化
插件通过安全的初始化流程确保数据加载的稳定性。`Initialize`函数在CurrencyStorage.lua中实现了这一流程：

```mermaid
flowchart TD
A[开始初始化] --> B{已初始化?}
B --> |是| C[返回true]
B --> |否| D[确保保存变量结构]
D --> E{结构有效?}
E --> |否| F[返回false]
E --> |是| G[初始化货币存储]
G --> H{初始化成功?}
H --> |否| I[返回false]
H --> |是| J[验证数据完整性]
J --> K[执行日志滚动]
K --> L[重置会话数据]
L --> M[标记为已初始化]
M --> N[返回true]
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L150-L195)

### 错误处理机制
插件实现了全面的错误处理机制来应对各种异常情况。在CurrencyStorage.lua中，`RecordCurrencyTransaction`函数展示了这一机制：

```mermaid
sequenceDiagram
participant 事件处理器 as EventHandler
participant 数据管理 as DataManager
participant 存储 as Storage
事件处理器->>数据管理 : TrackCurrencyChange()
数据管理->>存储 : RecordCurrencyTransaction()
存储->>存储 : 验证输入参数
存储->>存储 : 确保保存变量结构
存储->>存储 : 初始化货币数据(如果需要)
存储->>存储 : 更新所有相关时间段
存储->>存储 : 更新最后更新时间戳
存储->>数据管理 : 返回结果
数据管理->>事件处理器 : 返回结果
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L400-L450)
- [CurrencyDataManager.lua](file://CurrencyTracker/CurrencyDataManager.lua#L50-L100)
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua#L700-L750)

### 数据验证与修复
插件在加载数据时执行验证和修复操作。`ValidateData`函数在CurrencyStorage.lua中实现了这一功能：

```mermaid
classDiagram
class Storage {
+ValidateData()
+PreviewNegativeSourcesToBaseline()
+ApplyNegativeSourcesToBaseline()
+MigrateData(oldVersion, newVersion)
}
class DataValidator {
+validateCurrencyData()
+validateCurrencyOptions()
+validateCurrencyDiscovery()
+validateCurrencyMeta()
}
Storage --> DataValidator : 实现验证逻辑
```

**Diagram sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L850-L950)

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L150-L195)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L400-L450)

## 结论
Accountant_Classic插件通过保留旧字段、提供转换适配层和条件兼容逻辑来维持向后兼容性。当遇到无法解析的损坏数据时，插件采用使用默认值、跳过异常条目或记录警告日志的降级策略。结合CurrencyStorage.lua中的错误处理代码，插件实现了异常安全的数据加载流程，确保了插件的稳定性不受损坏数据的影响。这些策略共同确保了插件在不同版本和数据状态下的可靠运行。