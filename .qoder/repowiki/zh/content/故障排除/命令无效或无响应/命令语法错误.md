# 命令语法错误

<cite>
**本文档中引用的文件**  
- [CurrencyTracker-Usage.md](file://Docs/CurrencyTracker-Usage.md)
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua)
</cite>

## 目录
1. [简介](#简介)
2. [支持的Slash命令语法格式](#支持的slash命令语法格式)
3. [常见输入错误解析](#常见输入错误解析)
4. [命令解析逻辑与正则表达式匹配](#命令解析逻辑与正则表达式匹配)
5. [错误示例与修正对照表](#错误示例与修正对照表)
6. [获取实时语法提示](#获取实时语法提示)
7. [特殊字符输入处理](#特殊字符输入处理)

## 简介
本指南系统性地列举了 `/accountant`、`/acc`、`/ct` 及其子命令的正确用法，基于 `CurrencyTracker-Usage.md` 中的规范说明，解析用户在使用过程中可能出现的常见输入错误，如大小写混淆、参数缺失、非法字符等。通过分析 `CurrencyCore.lua` 文件中的命令解析逻辑，展示正则表达式匹配规则和参数提取流程，并提供错误示例与修正对照表，帮助用户正确使用 `/ct help` 获取实时语法提示，同时指导如何通过字符串转义处理特殊字符输入。

**Section sources**
- [CurrencyTracker-Usage.md](file://Docs/CurrencyTracker-Usage.md#L1-L243)

## 支持的Slash命令语法格式
以下是 `/ct` 命令支持的所有语法格式，包括别名和参数说明：

### /ct show
显示单个货币在指定时间段内的详细数据。

**语法：**
```
/ct show <timeframe> [currencyid]
```

**时间段（timeframe）：**
- `this-session`（别名：`session`）
- `today`
- `prv-day`
- `this-week`（别名：`week`）
- `prv-week`
- `this-month`（别名：`month`）
- `this-year`（别名：`year`）
- `prv-year`
- `total`

**示例：**
```
/ct show this-week 3008
/ct show today 3284
/ct show total 2815
```

**说明：**
- 若省略 `[currencyid]`，则使用最近选择的货币。
- 输出包含总收入、总支出及按来源分类的明细。

### /ct show-all-currencies
显示所有追踪货币在指定时间段内的汇总信息。

**语法：**
```
/ct show-all-currencies <timeframe>
```

**示例：**
```
/ct show-all-currencies this-session
/ct show-all-currencies this-week
/ct show-all-currencies total
```

**说明：**
- 每种货币显示收入、支出和净变化。
- 使用 `/ct show` 查看特定货币的详细分解。

### /ct meta show
查看原始元数据（用于研究或诊断），显示增益和损失/销毁来源代码的发生次数。

**语法：**
```
/ct meta show <timeframe> <currencyid>
```

**示例：**
```
/ct meta show today 3008
/ct meta show this-week 3284
```

### /ct debug
切换聊天窗口中的结构化事件日志。

**语法：**
```
/ct debug on
/ct debug off
```

### /ct status
打印内部状态信息。

**语法：**
```
/ct status
```

### /ct discover
管理动态发现的货币。

**语法：**
```
/ct discover list
/ct discover track <id> [on|off]
/ct discover clear
```

### /ct repair
修复工具，用于纠正数据或重新初始化货币存储。

**语法：**
```
/ct repair init
/ct repair adjust <id> <delta> [source]
/ct repair remove <id> <amount> <source> (income|outgoing)
```

**Section sources**
- [CurrencyTracker-Usage.md](file://Docs/CurrencyTracker-Usage.md#L25-L243)

## 常见输入错误解析
根据 `CurrencyTracker-Usage.md` 和 `CurrencyCore.lua` 的实现，以下是一些常见的输入错误及其原因：

### 大小写混淆
命令解析器对命令部分（如 `/ct`、`show`、`debug`）不区分大小写，但建议使用小写以保持一致性。例如：
- 正确：`/ct show this-week 3008`
- 错误：`/CT SHOW THIS-WEEK 3008`（虽可解析，但不符合规范）

### 参数缺失
某些命令必须提供参数，否则会提示用法错误。例如：
- 错误：`/ct show`（缺少 timeframe 和 currencyid）
- 正确：`/ct show this-week 3008`

### 非法字符
命令中不应包含非法字符或空格。例如：
- 错误：`/ct show this week 3008`（`this week` 应为 `this-week`）
- 正确：`/ct show this-week 3008`

### 时间段拼写错误
时间段名称必须完全匹配，否则无法识别。例如：
- 错误：`/ct show thisweek 3008`（缺少连字符）
- 正确：`/ct show this-week 3008`

### 货币ID格式错误
货币ID必须为正整数。例如：
- 错误：`/ct show this-week abc`（非数字）
- 正确：`/ct show this-week 3008`

**Section sources**
- [CurrencyTracker-Usage.md](file://Docs/CurrencyTracker-Usage.md#L25-L243)
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L952-L952)

## 命令解析逻辑与正则表达式匹配
在 `CurrencyCore.lua` 中，命令解析逻辑主要由 `ParseShowCommand` 函数实现，该函数负责从用户输入中提取时间段和可选的货币ID。

### ParseShowCommand 函数逻辑
```lua
function CurrencyTracker:ParseShowCommand(command)
    -- 将命令转换为小写并分割成部分
    local parts = {}
    for part in string.gmatch(string.lower(command or ""), "%S+") do
        table.insert(parts, part)
    end

    -- 检查最后一个部分是否为数字（即 currencyID）
    local currencyID = nil
    if #parts > 0 then
        local lastPart = parts[#parts]
        local num = tonumber(lastPart)
        if num and num > 0 then
            currencyID = num
            table.remove(parts, #parts) -- 移除已识别的 currencyID
        end
    end

    -- 移除动词（如 show, meta）
    if #parts > 0 and (parts[1] == "show" or parts[1] == "meta") then
        table.remove(parts, 1)
    end

    -- 映射时间段
    local timeframe = "Session"
    local tfMap = {
        ["this-session"] = "Session",
        ["session"] = "Session",
        ["today"] = "Day",
        -- ... 其他映射
    }

    if #parts > 0 then
        local key = parts[1]
        if tfMap[key] then
            timeframe = tfMap[key]
        else
            -- 子字符串搜索
            local joined = table.concat(parts, " ")
            for k, v in pairs(tfMap) do
                if string.find(joined, k, 1, true) then
                    timeframe = v
                    break
                end
            end
        end
    end

    return timeframe, currencyID
end
```

### 正则表达式匹配
命令解析使用了 Lua 的模式匹配功能，例如：
- `%S+`：匹配非空白字符序列（即单词）
- `string.match("remove%s+(%d+)%s+(%d+)%s+(%d+)%s+(%a+)")`：用于提取 `/ct repair remove` 命令的参数

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L952-L952)

## 错误示例与修正对照表
以下是一些常见错误及其修正方法：

| 错误命令 | 问题描述 | 修正命令 |
|--------|--------|--------|
| `/ct show achievement` | 参数类型错误，`achievement` 不是有效的 currencyID | `/ct show this-week 3008` |
| `/ct show this week 3008` | 时间段拼写错误，缺少连字符 | `/ct show this-week 3008` |
| `/ct show` | 缺少必要参数 | `/ct show this-week 3008` |
| `/CT SHOW THIS-WEEK 3008` | 大小写不规范 | `/ct show this-week 3008` |
| `/ct repair adjust 3008 -157` | 缺少 source 参数 | `/ct repair adjust 3008 -157 35` |

**Section sources**
- [CurrencyTracker-Usage.md](file://Docs/CurrencyTracker-Usage.md#L25-L243)
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L168-L168)

## 获取实时语法提示
用户可通过以下命令获取实时语法提示：

### /ct help
运行 `/ct` 或 `/ct help` 可在聊天窗口中显示内置帮助，列出所有可用命令及其用法。

**示例输出：**
```
CurrencyTracker Commands:
  /ct show this-session [currencyid] - Show currency data for current session
  /ct show today [currencyid] - Show currency data for today
  ...
  /ct help - Show this help message
```

该功能由 `ShowHelp` 函数实现，位于 `CurrencyCore.lua` 中。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L1360-L1360)

## 特殊字符输入处理
当输入包含特殊字符时，应使用字符串转义机制。例如，在配置近上限警告参数时：

### /ct set-paras near-cap-warning
此命令支持键值对输入，允许使用单位后缀（如 `s` 表示秒）和别名。

**示例：**
```
/ct set-paras near-cap-warning enable=true cap_percent=0.9 time_visible_sec=3s fade_duration_sec=0.8s
```

解析逻辑会自动去除单位后缀并转换小数点（支持逗号或点号）。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L700-L700)