# 故障排除

<cite>
**本文档中引用的文件**   
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua)
- [CurrencyDataManager.lua](file://CurrencyTracker/CurrencyDataManager.lua)
- [CharacterLogin-Process-Flow.md](file://Docs/CharacterLogin-Process-Flow.md)
- [Traders-Tender-Process-Flow.md](file://Docs/Traders-Tender-Process-Flow.md)
- [CurrencyConstants.lua](file://CurrencyTracker/CurrencyConstants.lua)
</cite>

## 目录
1. [简介](#简介)
2. [常见问题分类](#常见问题分类)
3. [诊断步骤](#诊断步骤)
4. [登录流程分析](#登录流程分析)
5. [商人交易流程分析](#商人交易流程分析)
6. [调试命令与日志](#调试命令与日志)
7. [错误日志解读与修复](#错误日志解读与修复)

## 简介
本指南旨在帮助用户解决在使用Accountant_Classic插件时遇到的常见问题。通过系统性地列出问题类别、提供详细的诊断步骤、分析关键流程图以及解释调试命令和日志，用户可以快速定位并解决故障。

## 常见问题分类
用户在使用过程中可能遇到以下几类常见问题：
- **数据不准确**：例如金币变动未记录。
- **界面不显示**：例如货币追踪界面无法正常显示。
- **命令无效**：例如输入的命令没有响应。
- **性能卡顿**：例如游戏运行缓慢或插件导致的延迟。

## 诊断步骤
针对上述问题，以下是详细的诊断步骤：

### 检查事件监听是否正常注册
确保插件的事件监听器已正确注册。可以通过检查`CurrencyEventHandler.lua`中的`RegisterEvents`函数来验证事件是否已注册。

```mermaid
flowchart TD
A[启动插件] --> B[调用RegisterEvents]
B --> C[注册ADDON_LOADED事件]
C --> D[注册PLAYER_LOGIN事件]
D --> E[注册PLAYER_ENTERING_WORLD事件]
E --> F[注册CURRENCY_DISPLAY_UPDATE事件]
F --> G[事件监听器准备就绪]
```

**图示来源**
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua#L180-L220)

### 验证SavedVariables文件完整性
检查`Accountant_ClassicSaveData`文件是否存在且结构完整。如果文件损坏或缺失，可能导致数据丢失或不准确。

```mermaid
flowchart TD
A[检查SavedVariables文件] --> B{文件存在?}
B --> |是| C[验证结构完整性]
B --> |否| D[创建新文件]
C --> E{结构完整?}
E --> |是| F[加载数据]
E --> |否| G[修复结构]
G --> F
F --> H[完成]
```

**图示来源**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L100-L150)

### 确认Ace3库正确加载
确保所有依赖的Ace3库（如AceAddon-3.0、AceEvent-3.0等）都已正确加载。可以通过检查`Libs`目录下的文件和`Core.lua`中的加载逻辑来确认。

```mermaid
flowchart TD
A[加载插件] --> B[检查Libs目录]
B --> C[加载AceAddon-3.0]
C --> D[加载AceEvent-3.0]
D --> E[加载其他Ace3库]
E --> F[所有库加载完成]
```

**图示来源**
- [Core.lua](file://Core/Core.lua#L50-L100)

## 登录流程分析
利用`CharacterLogin-Process-Flow.md`中的登录流程图，解释角色登录时的数据初始化顺序和潜在故障点。

```mermaid
flowchart TD
%% 子图：模块初始化与启用
subgraph INIT["初始化与启用阶段"]
A1["加载模块: CurrencyTracker:Initialize()"] --> A2["Storage:Initialize() (若存在)"]
A2 --> A3["DataManager:Initialize() (若存在)"]
A3 --> A4["EventHandler:Initialize()"]
A4 --> A5["CurrencyTracker:Enable()"]
A5 --> A6["EventHandler:Enable()"]
A6 --> A7["EventHandler:RegisterEvents()"]
A7 --> |注册| A7a["ADDON_LOADED / PLAYER_LOGIN / PLAYER_ENTERING_WORLD / ..."]
A7 --> |若 C_CurrencyInfo 存在| A7b["CURRENCY_DISPLAY_UPDATE"]
A7 --> |否则| A7c["BAG_UPDATE旧版回退"]
end
%% 子图：登录阶段直到世界载入完毕
subgraph LOGIN["登录到进入世界"]
B1["收到: PLAYER_LOGIN"] --> B2["EventHandler:OnPlayerLogin()"]
B2 --> B2a["InitializeCurrencyAmounts()"]
B2 --> B2b["Storage:ShiftCurrencyLogs()对齐汇总周期"]
B2 --> B2c["didLoginPrime ← false"]
B3["收到: PLAYER_ENTERING_WORLD(isInitialLogin=true, isReloadingUi=false)"] --> B4["EventHandler:OnPlayerEnteringWorld(...)"]
B4 --> |首登且非重载| B5["PrimeDiscoveredCurrenciesOnLogin()"]
B5 --> B5a["遍历已发现货币 id"]
B5a --> B5b["读取 live 数量 + Total.net"]
B5b --> |delta ≠ 0| B5c["Storage:ApplyTotalOnlyBaselineDelta(delta)"]
B5b --> |delta = 0| B5d["Storage:InitializeCurrencyData(id)"]
B5c --> B5e["seed: lastCurrencyAmounts[id] = live; primedCurrencies[id] = true"]
B5d --> B5e
end
%% 子图：第一次货币变动事件
subgraph FIRST_EVENT["第一次货币变动事件到达"]
C1["收到: CURRENCY_DISPLAY_UPDATE(...)"] --> C2["EventHandler:OnCurrencyDisplayUpdate(...)"]
C2 --> |inCombat = true| C2a["AddToBatch(...) 并延后处理"]
C2 --> |inCombat = false| C3["参数标准化去掉 table 前缀等"]
C3 --> C4["EventHandler:ProcessCurrencyChange(currencyID, newQty, qtyChange, gainSrc, lostSrc)"]
%% 旧版回退路径
D1["收到: BAG_UPDATE(bagID)"] --> D2["EventHandler:OnBagUpdate(bagID)"]
D2 --> |inCombat = true| D2a["AddToBatch('BAG_UPDATE', bagID)"]
D2 --> |inCombat = false| D3["0.3s 去抖后 CheckBagCurrencies()"]
D3 --> D4["检测到变动时 调用 ProcessCurrencyChange(...)"]
end
%% 连接阶段
A7a --> B1
A7a --> B3
A7b --> C1
A7c --> D1
```

**图示来源**
- [CharacterLogin-Process-Flow.md](file://Docs/CharacterLogin-Process-Flow.md)

## 商人交易流程分析
参考`Traders-Tender-Process-Flow.md`分析商人交易场景中的逻辑分支。

```mermaid
flowchart TD
%% Trader's Tender (2032) Lifecycle
subgraph LOGIN_PRIME[登录后基线检查]
LP1[PrimeDiscoveredCurrenciesOnLogin] --> LP2{2032?}
LP2 --> |否| LP3[继续下一个]
LP2 --> |是| LP4[读取 liveAmt 和 Total]
LP4 --> LP5{liveAmt 和 Total 差异?}
LP5 --> |是| LP6[ApplyTotalOnlyBaselineDelta]
LP6 --> LP7[更新 lastCurrencyAmounts]
LP5 --> |否| LP8[InitializeCurrencyData]
LP8 --> LP7
LP7 --> LP9[primedCurrencies = true]
end
subgraph FIRST_EVENT[首次 CURRENCY_DISPLAY_UPDATE]
FE1[收到事件参数] --> FE2{2032?}
FE2 --> |否| FE3[走通用流程]
FE2 --> |是| FE4[HandleZeroChangeCurrency]
FE4 --> FE5{已 prime?}
FE5 --> |是| SE1
FE5 --> |否| FE6{quantityChange 非零?}
FE6 --> |是| FE7[pre = new - quantityChange]
FE7 --> FE8[base = Total 或 0]
FE8 --> FE9[ApplyTotalOnlyBaselineDelta]
FE9 --> FE10[TrackCurrencyChange quantityChange]
FE6 --> |否| FE11[base = Total 或 0]
FE11 --> FE12[ApplyTotalOnlyBaselineDelta]
FE12 --> FE13[更新快照]
FE10 --> FE13
FE13 --> FE14[primedCurrencies = true]
end
subgraph SUBSEQUENT_EVENT[后续 CURRENCY_DISPLAY_UPDATE]
SE1[HandleZeroChangeCurrency 已 prime] --> SE2{quantityChange == 0?}
SE2 --> |是| SE3[delta = new - last]
SE3 --> SE4{delta == 0?}
SE4 --> |是| SE5[仅更新快照]
SE4 --> |否| SE6[记录元数据]
SE6 --> SE7[TrackCurrencyChange delta]
SE7 --> SE8[更新快照]
SE2 --> |否| SE9[delta = new - last]
SE9 --> SE10[记录元数据]
SE10 --> SE11[TrackCurrencyChange delta]
SE11 --> SE8
end
LP9 --> FE1
FE14 --> SE1
```

**图示来源**
- [Traders-Tender-Process-Flow.md](file://Docs/Traders-Tender-Process-Flow.md)

## 调试命令与日志
提供调试命令（如/ct debug）的使用方法来启用详细日志输出。

### 启用调试模式
输入`/ct debug`命令以启用调试模式，这将显示详细的日志信息，帮助诊断问题。

```lua
-- 在CurrencyEventHandler.lua中启用调试模式
function EventHandler:EnableDebug()
    CurrencyTracker.DEBUG_MODE = true
    print("[AC CT] Debug mode enabled")
end
```

**节来源**
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua#L500-L510)

## 错误日志解读与修复
给出典型错误日志的解读方法和修复方案，如数据库损坏时的重置步骤。

### 数据库损坏修复
当发现数据库损坏时，可以按照以下步骤进行修复：

1. **备份当前数据**：首先备份`Accountant_ClassicSaveData.lua`文件。
2. **重置数据库**：使用`/ct reset`命令重置数据库。
3. **重新加载插件**：重新加载插件以应用更改。

```lua
-- 在CurrencyStorage.lua中重置数据库
function Storage:ResetAllData()
    if not EnsureSavedVariablesStructure() then
        return false
    end
    local server, character = GetCurrentServerAndCharacter()
    local sv = _G.Accountant_ClassicSaveData
    if sv and sv[server] and sv[server][character] then
        sv[server][character].currencyData = {}
        sv[server][character].currencyOptions = {
            selectedCurrency = DEFAULT_CURRENCY,
            trackingEnabled = true,
            lastUpdate = time(),
            version = CURRENCY_VERSION
        }
        SafeLogDebug("All currency data reset for %s-%s", server, character)
        return true
    end
    return false
end
```

**节来源**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L800-L850)