# 添加新的金币来源类型

<cite>
**本文档中引用的文件**  
- [Constants.lua](file://Core/Constants.lua)
- [Core.lua](file://Core/Core.lua)
- [MoneyFrame.lua](file://Core/MoneyFrame.lua)
- [localization.en.lua](file://Locale/localization.en.lua)
</cite>

## 目录
1. [简介](#简介)
2. [在Constants.lua中定义新的来源常量](#在constantslua中定义新的来源常量)
3. [在Core.lua中注册游戏事件](#在corelua中注册游戏事件)
4. [在MoneyFrame.lua中更新UI显示](#在moneyframelua中更新ui显示)
5. [完整流程示例](#完整流程示例)
6. [常见错误与调试建议](#常见错误与调试建议)
7. [结论](#结论)

## 简介
本指南旨在为开发者提供详细的步骤，以扩展Accountant_Classic插件的金币来源分类系统。通过遵循本指南，开发者可以轻松地添加新的金币来源类型，包括定义常量、注册事件和更新用户界面。整个过程涉及三个核心文件：`Constants.lua`、`Core.lua`和`MoneyFrame.lua`。每个步骤都经过精心设计，确保新功能的无缝集成。

**Section sources**
- [Constants.lua](file://Core/Constants.lua#L1-L261)
- [Core.lua](file://Core/Core.lua#L1-L2306)
- [MoneyFrame.lua](file://Core/MoneyFrame.lua#L1-L169)

## 在Constants.lua中定义新的来源常量
在`Constants.lua`文件中，首先需要定义新的来源常量和对应的本地化键名。这些常量用于标识不同的金币来源类型，并在后续的事件处理和UI显示中使用。

```lua
-- 在Constants.lua中添加新的来源常量
constants.logtypes = {
    "TRAIN", "TAXI", "TRADE", "AH", "MERCH", "REPAIRS", "MAIL", "QUEST", "LOOT", "OTHER", "NEW_SOURCE"
}

constants.onlineData = {
    ["NEW_SOURCE"] = { Title = L["New Source"] };
}
```

**Section sources**
- [Constants.lua](file://Core/Constants.lua#L100-L130)

## 在Core.lua中注册游戏事件
在`Core.lua`文件中，需要注册与新来源相关的游戏事件，并更新事件处理器逻辑。这确保了在上下文切换时能够正确归因金币变动。

```lua
-- 在Core.lua中注册新的游戏事件
function addon:OnEvent(event, arg1, arg2)
    if event == "NEW_EVENT" then
        AC_LOGTYPE = "NEW_SOURCE"
    end
end
```

**Section sources**
- [Core.lua](file://Core/Core.lua#L1482-L1551)

## 在MoneyFrame.lua中更新UI显示
在`MoneyFrame.lua`文件中，需要更新UI显示逻辑，将新来源纳入统计表格渲染。这包括创建新的UI元素和更新现有的显示逻辑。

```lua
-- 在MoneyFrame.lua中更新UI显示逻辑
local function createMoneyFrame()
    local f = CreateFrame("Frame", "AccountantClassicMoneyInfoFrame", UIParent)
    f:SetWidth(160)
    f:SetHeight(21)
    f:SetPoint("TOPLEFT", UIParent, "TOPLEFT", 10, -80)
    f:SetClampedToScreen(true)
    f:SetMovable(true)
    f:EnableMouse(true)
    f:RegisterForDrag("LeftButton")
    
    f.Text = f:CreateFontString("AccountantClassicMoneyInfoText", "OVERLAY", "GameFontNormal")
    f.Text:SetPoint("TOPLEFT", f, "TOPLEFT", 0, 0)
    f.Text:SetText(L["Accountant Classic"])
    f:SetScript("OnUpdate", frame_OnUpdate)
    f:SetScript("OnMouseDown", frame_OnMouseDown)
    f:SetScript("OnMouseUp", frame_OnMouseUp)
    f:SetScript("OnEnter", frame_OnEnter)
    f:SetScript("OnLeave", frame_OnLeave)
    return f
end
```

**Section sources**
- [MoneyFrame.lua](file://Core/MoneyFrame.lua#L1-L169)

## 完整流程示例
以下是一个完整的示例，展示了从常量定义到事件绑定再到UI更新的全流程。

```lua
-- Constants.lua
constants.logtypes = {
    "TRAIN", "TAXI", "TRADE", "AH", "MERCH", "REPAIRS", "MAIL", "QUEST", "LOOT", "OTHER", "NEW_SOURCE"
}

constants.onlineData = {
    ["NEW_SOURCE"] = { Title = L["New Source"] };
}

-- Core.lua
function addon:OnEvent(event, arg1, arg2)
    if event == "NEW_EVENT" then
        AC_LOGTYPE = "NEW_SOURCE"
    end
end

-- MoneyFrame.lua
local function createMoneyFrame()
    local f = CreateFrame("Frame", "AccountantClassicMoneyInfoFrame", UIParent)
    f:SetWidth(160)
    f:SetHeight(21)
    f:SetPoint("TOPLEFT", UIParent, "TOPLEFT", 10, -80)
    f:SetClampedToScreen(true)
    f:SetMovable(true)
    f:EnableMouse(true)
    f:RegisterForDrag("LeftButton")
    
    f.Text = f:CreateFontString("AccountantClassicMoneyInfoText", "OVERLAY", "GameFontNormal")
    f.Text:SetPoint("TOPLEFT", f, "TOPLEFT", 0, 0)
    f.Text:SetText(L["Accountant Classic"])
    f:SetScript("OnUpdate", frame_OnUpdate)
    f:SetScript("OnMouseDown", frame_OnMouseDown)
    f:SetScript("OnMouseUp", frame_OnMouseUp)
    f:SetScript("OnEnter", frame_OnEnter)
    f:SetScript("OnLeave", frame_OnLeave)
    return f
end
```

**Section sources**
- [Constants.lua](file://Core/Constants.lua#L100-L130)
- [Core.lua](file://Core/Core.lua#L1482-L1551)
- [MoneyFrame.lua](file://Core/MoneyFrame.lua#L1-L169)

## 常见错误与调试建议
在扩展金币来源分类系统时，可能会遇到一些常见错误。以下是几个常见的问题及其解决方法：

1. **事件监听遗漏**：确保在`Core.lua`中正确注册了所有相关的游戏事件。遗漏事件监听会导致金币变动无法正确归因。
2. **数据归因偏差**：检查`AC_LOGTYPE`的设置是否正确。错误的`AC_LOGTYPE`值会导致金币变动被错误分类。
3. **UI更新失败**：确认`MoneyFrame.lua`中的UI元素是否正确创建和更新。UI更新失败可能导致新来源的统计信息无法显示。

**Section sources**
- [Core.lua](file://Core/Core.lua#L1482-L1551)
- [MoneyFrame.lua](file://Core/MoneyFrame.lua#L1-L169)

## 结论
通过遵循本指南，开发者可以轻松地扩展Accountant_Classic插件的金币来源分类系统。从定义常量到注册事件再到更新UI显示，每一步都经过精心设计，确保新功能的无缝集成。希望本指南能帮助开发者顺利完成新功能的实现。

**Section sources**
- [Constants.lua](file://Core/Constants.lua#L1-L261)
- [Core.lua](file://Core/Core.lua#L1-L2306)
- [MoneyFrame.lua](file://Core/MoneyFrame.lua#L1-L169)