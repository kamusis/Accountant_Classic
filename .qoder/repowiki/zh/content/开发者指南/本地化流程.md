# 本地化流程

<cite>
**本文档中引用的文件**  
- [localization.en.lua](file://Locale/localization.en.lua)
- [localization.cn.lua](file://Locale/localization.cn.lua)
- [Locales.xml](file://Locale/Locales.xml)
- [Config.lua](file://Core/Config.lua)
- [Core.lua](file://Core/Core.lua)
- [AceLocale-3.0.lua](file://Libs/AceLocale-3.0/AceLocale-3.0.lua)
</cite>

## 目录
1. [简介](#简介)
2. [Locale目录结构](#locale目录结构)
3. [AceLocale-3.0机制](#acelocale-30机制)
4. [语言文件定义](#语言文件定义)
5. [代码中调用翻译](#代码中调用翻译)
6. [配置文件本地化](#配置文件本地化)
7. [新增语言文件流程](#新增语言文件流程)
8. [翻译一致性检查](#翻译一致性检查)

## 简介
本指南详细说明如何为Accountant_Classic插件添加多语言支持。通过使用AceLocale-3.0库，开发者可以轻松实现插件的国际化，确保不同语言区域的玩家都能获得良好的用户体验。本指南将涵盖从目录结构到代码实现的完整本地化流程。

## Locale目录结构
Locale目录包含所有语言文件和注册配置，是多语言支持的核心。该目录通过Locales.xml文件集中管理所有语言资源的加载。

```mermaid
graph TB
Locale[Locale目录] --> LocalesXML[Locales.xml]
Locale --> enUS[localization.en.lua]
Locale --> zhCN[localization.cn.lua]
Locale --> deDE[localization.de.lua]
Locale --> frFR[localization.fr.lua]
Locale --> esES[localization.es.lua]
Locale --> itIT[localization.it.lua]
Locale --> ptBR[localization.ptBR.lua]
Locale --> ruRU[localization.ru.lua]
Locale --> globalstrings[globalstrings.lua]
style Locale fill:#f9f,stroke:#333
style LocalesXML fill:#bbf,stroke:#333
style enUS fill:#dfd,stroke:#333
style zhCN fill:#dfd,stroke:#333
```

**Diagram sources**
- [Locales.xml](file://Locale/Locales.xml#L1-L15)
- [localization.en.lua](file://Locale/localization.en.lua#L1-L259)
- [localization.cn.lua](file://Locale/localization.cn.lua#L1-L251)

**Section sources**
- [Locales.xml](file://Locale/Locales.xml#L1-L15)

## AceLocale-3.0机制
AceLocale-3.0是插件本地化的核心库，提供了一套完整的多语言管理机制。它通过LibStub进行版本控制和依赖管理，确保不同插件间的兼容性。

```mermaid
sequenceDiagram
participant LibStub as LibStub
participant AceLocale as AceLocale-3.0
participant enUS as localization.en.lua
participant zhCN as localization.cn.lua
participant Code as 插件代码
LibStub->>AceLocale : GetLibrary("AceLocale-3.0")
AceLocale-->>LibStub : 返回AceLocale实例
enUS->>AceLocale : NewLocale("Accountant_Classic", "enUS", true)
zhCN->>AceLocale : NewLocale("Accountant_Classic", "zhCN")
AceLocale->>AceLocale : 注册语言表
Code->>AceLocale : GetLocale("Accountant_Classic")
AceLocale-->>Code : 返回当前语言表L
Code->>Code : L["KEY_NAME"]获取翻译文本
```

**Diagram sources**
- [AceLocale-3.0.lua](file://Libs/AceLocale-3.0/AceLocale-3.0.lua#L1-L134)

**Section sources**
- [AceLocale-3.0.lua](file://Libs/AceLocale-3.0/AceLocale-3.0.lua#L1-L134)

## 语言文件定义
语言文件采用键值对形式定义翻译文本，每个文件对应一种语言。英文文件通常作为默认语言和模板。

```lua
-- 示例：localization.en.lua
local AceLocale = LibStub:GetLibrary("AceLocale-3.0");
local L = AceLocale:NewLocale("Accountant_Classic", "enUS", true, true);

if not L then return end

L["Accountant Classic"] = "Accountant Classic"
L["Total Incomings"] = "Total Incomings"
L["Total Outgoings"] = "Total Outgoings"
```

```lua
-- 示例：localization.cn.lua
local L = LibStub("AceLocale-3.0"):NewLocale("Accountant_Classic", "zhCN", false)

if not L then return end

L["Accountant Classic"] = "Accountant Classic"
L["Total Incomings"] = "总收入"
L["Total Outgoings"] = "总支出"
```

**Section sources**
- [localization.en.lua](file://Locale/localization.en.lua#L1-L259)
- [localization.cn.lua](file://Locale/localization.cn.lua#L1-L251)

## 代码中调用翻译
在Lua代码中通过L['KEY_NAME']语法调用翻译文本，确保所有用户可见字符串都经过本地化处理。

```mermaid
flowchart TD
Start([代码入口]) --> CheckLocale["获取本地化表L"]
CheckLocale --> IsValid{"L存在?"}
IsValid --> |否| Return["返回nil"]
IsValid --> |是| GetText["L['KEY_NAME']获取文本"]
GetText --> HasTranslation{"有翻译?"}
HasTranslation --> |是| ReturnText["返回翻译文本"]
HasTranslation --> |否| ReturnKey["返回KEY_NAME"]
ReturnText --> End([函数退出])
ReturnKey --> End
Return --> End
```

**Diagram sources**
- [Core.lua](file://Core/Core.lua#L1-L2335)
- [Config.lua](file://Core/Config.lua#L1-L431)

**Section sources**
- [Core.lua](file://Core/Core.lua#L1-L2335)
- [Config.lua](file://Core/Config.lua#L1-L431)

## 配置文件本地化
在Config.lua中配置选项时，使用本地化键名确保界面元素的文本可被翻译。

```lua
-- 示例：Config.lua中的本地化使用
args = {
    general = {
        name = L["Options"],
        args = {
            showmoneyinfo = {
                name = L["Show money on screen"],
                desc = L["Display Instruction Tips"],
            },
            weekstart = {
                name = L["Start of Week"],
                values = function()
                    return { 
                        L["WEEKDAY_SUNDAY"], 
                        L["WEEKDAY_MONDAY"],
                    }
                end,
            },
        },
    },
}
```

**Section sources**
- [Config.lua](file://Core/Config.lua#L1-L431)

## 新增语言文件流程
添加新语言支持需要完成三个步骤：创建语言文件、翻译内容、注册到配置。

```mermaid
graph TD
A[开始] --> B[复制模板文件]
B --> C[重命名为localization.xx.lua]
C --> D[修改语言代码参数]
D --> E[翻译所有键值对]
E --> F[检查特殊字符]
F --> G[添加到Locales.xml]
G --> H[测试翻译效果]
H --> I[完成]
style A fill:#f96,stroke:#333
style I fill:#6f9,stroke:#333
```

**Diagram sources**
- [Locales.xml](file://Locale/Locales.xml#L1-L15)
- [localization.en.lua](file://Locale/localization.en.lua#L1-L259)

**Section sources**
- [Locales.xml](file://Locale/Locales.xml#L1-L15)
- [localization.en.lua](file://Locale/localization.en.lua#L1-L259)

## 翻译一致性检查
确保翻译质量和界面显示的稳定性，需要进行严格的一致性检查。

```mermaid
flowchart LR
A[翻译检查] --> B[键名一致性]
A --> C[特殊字符处理]
A --> D[文本长度评估]
A --> E[占位符匹配]
A --> F[编码格式验证]
B --> B1[所有文件包含相同键名]
C --> C1[转义引号、换行符]
D --> D1[避免过长文本]
E --> E1[%s, %d等占位符]
F --> F1[UTF-8编码]
```

**Diagram sources**
- [localization.en.lua](file://Locale/localization.en.lua#L1-L259)
- [localization.cn.lua](file://Locale/localization.cn.lua#L1-L251)

**Section sources**
- [localization.en.lua](file://Locale/localization.en.lua#L1-L259)
- [localization.cn.lua](file://Locale/localization.cn.lua#L1-L251)