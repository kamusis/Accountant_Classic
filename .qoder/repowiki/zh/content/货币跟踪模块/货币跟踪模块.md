# 货币跟踪模块

<cite>
**本文档引用文件**   
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua)
- [CurrencyFrame.lua](file://CurrencyTracker/CurrencyFrame.lua)
- [CurrencyConstants.lua](file://CurrencyTracker/CurrencyConstants.lua)
- [CurrencyTracker-Usage.md](file://Docs/CurrencyTracker-Usage.md)
- [CurrencyTracker-UI-Design.md](file://Docs/CurrencyTracker-UI-Design.md)
</cite>

## 目录
1. [简介](#简介)
2. [模块架构与设计模式](#模块架构与设计模式)
3. [CLI命令系统](#cli命令系统)
4. [数据模型](#数据模型)
5. [UI与CLI的互补关系](#ui与cli的互补关系)
6. [扩展接口说明](#扩展接口说明)

## 简介
货币跟踪模块是Accountant Classic插件的一个独立扩展功能，专门用于跟踪除金币外的其他游戏内货币，如荣誉点、征服点、时空扭曲徽章等。该模块采用CLI（命令行界面）优先的设计模式，通过`/ct`命令提供完整的功能访问。模块与金币跟踪系统完全解耦，拥有独立的数据存储和处理逻辑。其设计遵循“预览/应用”模式，确保CLI与UI共享同一套数据处理逻辑，避免了功能重复和状态不一致。

## 模块架构与设计模式
货币跟踪模块采用分层架构，核心组件包括`CurrencyCore`（核心协调）、`CurrencyStorage`（数据存储）、`CurrencyDataManager`（数据管理）、`CurrencyEventHandler`（事件处理）和`CurrencyFrame`（UI）。模块的CLI设计模式是其核心特征，所有功能首先通过`/ct`命令实现，UI作为可选的补充视图。这种模式确保了功能逻辑的集中化，CLI是唯一的数据写入和状态变更入口，而UI仅负责数据的读取和渲染。

模块通过`CurrencyCore.lua`中的`SlashCmdList["CURRENCYTRACKER"]`函数解析用户输入，并将其映射到内部函数调用。例如，`/ct show total 1166`命令会调用`CurrencyTracker:ShowCurrencyData()`函数，该函数进一步调用`ParseShowCommand()`解析时间范围和货币ID，最终通过`PrintCurrencyData()`输出结果。这种设计使得命令解析器成为整个模块的控制中心。

**Section sources**
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L556-L586)
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L907-L934)

## CLI命令系统
`/ct`命令是访问货币跟踪模块功能的主要方式。命令系统设计清晰，功能明确，涵盖了数据查询、状态管理和修复工具。

### 主要子命令
- **show**: 显示单个货币在指定时间范围内的详细数据。语法为`/ct show <timeframe> [currencyid]`。时间范围包括`this-session`、`today`、`this-week`、`total`等。
- **show-all-currencies**: 显示所有已跟踪货币在指定时间范围内的汇总数据。语法为`/ct show-all-currencies <timeframe>`。此命令是`show-all`的别名。
- **debug**: 切换调试日志。`/ct debug on`开启后，每个处理的事件都会在聊天框中打印详细的调试信息，有助于验证数据流和写入路径。
- **status**: 打印模块的内部状态，包括初始化、启用状态和调试模式，用于确认模块是否正常工作。
- **ui**: 打开独立的货币跟踪UI窗口，提供图形化视图。

### 发现与管理命令
- **discover list**: 列出所有已发现的货币ID。
- **discover track <id> [on|off]**: 切换指定货币的跟踪状态。`on`表示开始跟踪，`off`表示停止跟踪。
- **discover clear**: 清除当前角色的所有已发现货币。

### 修复工具
- **repair init**: 重置当前角色的货币跟踪存储。
- **repair adjust <id> <delta> [source]**: 对指定货币应用一个有符号的修正值。正数增加收入，负数增加支出。
- **repair remove <id> <amount> <source> (income|outgoing)**: 从指定货币的记录中移除已记录的金额。

**Section sources**
- [CurrencyTracker-Usage.md](file://Docs/CurrencyTracker-Usage.md#L0-L243)
- [CurrencyCore.lua](file://CurrencyTracker/CurrencyCore.lua#L588-L616)

## 数据模型
数据模型是货币跟踪模块的核心，定义了数据的结构和存储方式。主要由`currencyData`和`currencyDiscovery`两个结构组成。

### currencyData结构
`currencyData`存储了每个货币在不同时间范围内的交易记录。其结构如下：
```
currencyData = {
    [currencyID] = {
        Session = { [source] = { In = 0, Out = 0 } },
        Day = { ... },
        Week = { ... },
        Month = { ... },
        Year = { ... },
        Total = { ... }
    }
}
```
每个时间范围（如`Session`）是一个表，其键为`source`（来源），值为一个包含`In`（收入）和`Out`（支出）的表。`source`可以是数字代码（如16代表随机战场）或字符串（如"BaselinePrime"代表初始余额）。这种设计允许对同一货币的收入和支出按来源进行精确分类。

### currencyDiscovery结构
`currencyDiscovery`存储了动态发现的货币元数据，结构如下：
```
currencyDiscovery = {
    [currencyID] = {
        id = 3008,
        name = "Valorstones",
        icon = 123456,
        expansion = "TWW",
        expansionName = "The War Within",
        patch = "11.0.0",
        category = "Special",
        tracked = true
    }
}
```
该结构在`CurrencyStorage.lua`中通过`GetDiscoveredCurrencies()`和`SaveDiscoveredCurrency()`函数进行访问和管理。`tracked`字段决定了该货币是否被`show-all-currencies`等命令包含。

**Section sources**
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L568-L617)
- [CurrencyStorage.lua](file://CurrencyTracker/CurrencyStorage.lua#L1064-L1107)

## UI与CLI的互补关系
`CurrencyFrame.lua`提供的UI是CLI功能的有限补充，遵循“预览/应用”模式，不重复实现任何逻辑。

### 设计原则
UI的设计原则是复用CLI的逻辑，而不是替代它。根据`CurrencyTracker-UI-Design.md`文档，UI与CLI的交互规则如下：
- **数据读取**：UI直接调用`CurrencyTracker.Storage`和`CurrencyTracker.DataManager`的只读接口，如`GetDiscoveredCurrencies()`和`GetCurrencyData(id, timeframe)`。
- **状态变更**：涉及数据写入的操作（如切换货币的跟踪状态），UI通过调用CLI的处理函数来复用逻辑，例如`CurrencyTracker:DiscoverTrack(sub)`。
- **不依赖CLI解析器**：UI不使用`CurrencyTracker:ParseShowCommand()`来构造内部状态，而是维护自己的状态机。

### 功能互补
UI提供了CLI所不具备的视觉优势：
- **表格视图**：以表格形式展示所有货币的汇总数据，比CLI的文本输出更直观。
- **图标显示**：在表格中显示货币的图标，增强可识别性。
- **下拉选择**：提供服务器、角色和货币的下拉菜单，方便在不同角色和货币间切换。
- **持久化状态**：可以保存最近一次的时间范围、服务器和货币选择，下次打开时恢复。

然而，UI的功能是CLI的子集。所有在UI中能执行的操作，都可以通过`/ct`命令完成。UI的存在是为了提升用户体验，而不是引入新的功能。

**Section sources**
- [CurrencyFrame.lua](file://CurrencyTracker/CurrencyFrame.lua#L443-L471)
- [CurrencyTracker-UI-Design.md](file://Docs/CurrencyTracker-UI-Design.md#L62-L75)

## 扩展接口说明
为希望扩展新货币类型的开发者，模块提供了清晰的接口。

### 常量定义
在`CurrencyConstants.lua`中，`CurrencyConstants.SupportedCurrencies`表定义了所有受支持的货币及其元数据。开发者可以在此添加新的货币ID、名称、图标和所属资料片。例如：
```lua
[3089] = {
    id = 3089,
    name = "Residual Memories",
    expansion = "TWW",
    expansionName = "The War Within",
    patch = "11.0.0",
    isTracked = true,
    category = "Special"
}
```

### 白名单机制
`CurrencyConstants.CurrencyWhitelist`是一个货币ID的列表，用于可选的显示过滤。`show-all-currencies`命令默认只显示白名单中的货币，除非使用`verbose`参数。开发者可以将新添加的货币ID加入此列表，使其在汇总视图中可见。

### 事件处理
对于有特殊行为的货币（如交易券），可以在`CurrencyEventHandler.lua`中添加专门的处理函数。模块通过`CURRENCY_DISPLAY_UPDATE`事件接收货币变化，并在`ProcessCurrencyChange()`函数中进行处理。开发者可以在此函数中添加对特定`currencyID`的条件判断，以实现自定义逻辑。

**Section sources**
- [CurrencyConstants.lua](file://CurrencyTracker/CurrencyConstants.lua#L51-L554)
- [CurrencyEventHandler.lua](file://CurrencyTracker/CurrencyEventHandler.lua#L53-L76)